# 画像アップロード機能 仕様書

## 概要

チャットメッセージにユーザーが画像を添付し、Claude Vision API で画像内容を認識した上でAIが応答する機能。

## 機能要件

### 画像アップロード
- ファイル選択ボタンから画像を選択して添付できる
- 対応フォーマット: JPEG, PNG, GIF, WebP
- ファイルサイズ上限: 5MB
- 1メッセージにつき1枚まで

### 送信パターン
- テキスト + 画像: テキストと画像を同時に送信できる
- 画像のみ: テキストなしで画像だけを送信できる
- テキストのみ: 従来通りテキストのみの送信も可能（既存機能）

### AI画像認識
- Claude Vision API を利用し、画像の内容を理解した上で応答する
- 画像付きメッセージも会話履歴としてコンテキストに含まれる

### 画像表示
- チャットバブル内にサムネイル表示
- サムネイルクリックでモーダルによる拡大表示（原寸大）

### 送信前プレビュー
- 画像選択後、入力欄の上部にサムネイルプレビューを表示
- プレビューにキャンセル（×）ボタンを配置し、添付を取り消せる

## バリデーション

### クライアントサイド
- ファイル形式チェック（`accept` 属性 + JavaScript 検証）
- ファイルサイズチェック（5MB 超過時はエラーメッセージ表示）
- 送信ボタンの有効/無効制御（テキストも画像もない場合は無効）

### サーバーサイド
- ファイル形式の再検証（MIME type チェック）
- ファイルサイズの再検証（5MB 上限）
- アップロード失敗時はエラーレスポンスを返す

## アーキテクチャ

### 処理フロー

```
1. ユーザーがファイル選択ボタンで画像を選択
2. クライアントでバリデーション（形式・サイズ）
3. 入力欄上部にプレビュー表示
4. 送信ボタン押下
5. POST /api/upload で画像を Supabase Storage にアップロード
6. アップロード成功後、返却された imageUrl を含めて POST /api/chat を呼び出し
7. サーバーで画像URLから画像を取得し、Claude Vision API に送信
8. ストリーミング応答を返却
```

### 新規ファイル

```
src/
├── app/
│   └── api/
│       └── upload/
│           └── route.ts        # POST /api/upload: 画像アップロード API
├── components/
│   ├── ImagePreview.tsx        # 送信前プレビュー（サムネイル + キャンセルボタン）
│   └── ImageModal.tsx          # 拡大表示モーダル
```

### 変更ファイル

```
src/
├── app/
│   └── api/
│       └── chat/
│           └── route.ts        # 画像付きメッセージ対応
├── components/
│   ├── ChatContainer.tsx       # 画像アップロード状態管理の追加
│   ├── MessageBubble.tsx       # 画像表示の追加
│   └── MessageInput.tsx        # ファイル選択ボタンの追加
├── types/
│   └── chat.ts                 # Message 型に image_url を追加
```

## API設計

### POST /api/upload（新規）

画像を Supabase Storage にアップロードする。

- **リクエスト**: `multipart/form-data`
  - `file`: 画像ファイル（必須）
  - `threadId`: スレッドID（必須、ストレージパスに使用）
- **レスポンス（成功）**: `{ imageUrl: string }`
- **レスポンス（エラー）**:
  - `400`: ファイル未指定、形式不正、サイズ超過
  - `500`: Supabase Storage アップロード失敗

### POST /api/chat（変更）

- **リクエスト**: `{ threadId: string, message: string, imageUrl?: string }`
  - `message` は空文字を許可（画像のみ送信時）
  - `imageUrl` が指定された場合、Claude Vision API に画像を含めて送信
- **バリデーション**: `message` と `imageUrl` の両方が空の場合は `400` エラー

## データベース設計

### messages テーブル（変更）

| カラム | 型 | 説明 |
|--------|------|------|
| image_url | text (nullable) | Supabase Storage 上の画像URL。画像なしの場合は NULL |

### マイグレーション SQL

```sql
ALTER TABLE messages ADD COLUMN image_url text;
```

## Supabase Storage 設計

### バケット
- バケット名: `chat-images`
- 公開設定: public（認証なし・個人利用のため）

### ファイルパス
```
chat-images/{threadId}/{uuid}.{ext}
```
- `threadId`: スレッドごとにディレクトリを分離
- `uuid`: ファイル名の衝突を防止するためランダムUUIDを使用
- `ext`: 元のファイルの拡張子を保持

## 型定義

### Message 型（変更）

```typescript
export type Message = {
  id: string;
  thread_id: string;
  role: "user" | "assistant";
  content: string;
  image_url?: string | null; // 追加
  created_at: string;
};
```

## UIデザイン

### MessageInput（変更）

```
┌──────────────────────────────────────────┐
│ [画像プレビュー サムネイル] [×]           │  ← 画像選択時のみ表示
├──────────────────────────────────────────┤
│ [📎] [テキスト入力エリア...        ] [送信] │
└──────────────────────────────────────────┘
```

- `📎`（クリップアイコン）ボタンをテキストエリアの左に配置
- クリックで `<input type="file" accept="image/*">` を発火

### MessageBubble（変更）

```
┌────────────────────────┐
│ ┌────────────────────┐ │
│ │                    │ │  ← サムネイル画像（クリックで拡大）
│ │      画像          │ │
│ │                    │ │
│ └────────────────────┘ │
│ テキストメッセージ...    │  ← テキストがある場合のみ表示
└────────────────────────┘
```

- 画像はバブル内の上部に表示
- テキストがある場合はその下に表示
- 画像クリックでモーダル表示

### ImageModal

```
┌──────────────────────────────────────┐
│                               [×]    │
│                                      │
│          原寸大の画像表示             │
│                                      │
│                                      │
└──────────────────────────────────────┘
```

- 半透明オーバーレイ + 中央に画像表示
- ×ボタンまたはオーバーレイクリックで閉じる
- Escape キーでも閉じる

## エラーハンドリング

| エラーケース | 表示方法 |
|-------------|---------|
| ファイル形式不正 | 入力欄付近にインラインエラー表示 |
| ファイルサイズ超過 | 入力欄付近にインラインエラー表示 |
| アップロード失敗（Storage） | 入力欄付近にインラインエラー表示 |
| Claude API エラー（画像認識含む） | メッセージバブル内に赤背景でエラー表示（既存動作と同様） |

## Claude Vision API 連携

### メッセージ構築

画像付きメッセージの場合、Claude API の `messages` パラメータの `content` を配列形式に変更する。

```typescript
// 画像付きメッセージの場合
{
  role: "user",
  content: [
    {
      type: "image",
      source: {
        type: "url",
        url: imageUrl,
      },
    },
    {
      type: "text",
      text: message || "この画像について教えてください",
    },
  ],
}

// テキストのみの場合（従来通り）
{
  role: "user",
  content: message,
}
```

- 画像のみ送信（テキストなし）の場合、デフォルトテキスト「この画像について教えてください」を補完する
- 会話履歴に画像付きメッセージが含まれる場合も、同様に配列形式で Claude API に送信する

## 制約・前提条件

- 認証なし（個人利用）のため、Supabase Storage は public バケットで運用
- 画像の圧縮・リサイズは行わない（5MB 上限で十分小さいため）
- 画像の削除機能は初期スコープ外（将来的にスレッド削除時にまとめて削除する想定）
